apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: postgres-backup-pvc
    labels:
        app: marketplace-price-tracker
        component: postgres-backup
spec:
    accessModes:
        - ReadWriteOnce
    resources:
        requests:
            storage: 5Gi
    storageClassName: local-path
---
apiVersion: batch/v1
kind: CronJob
metadata:
    name: postgres-backup
    labels:
        app: marketplace-price-tracker
        component: postgres-backup
spec:
    schedule: "0 2 * * *"
    concurrencyPolicy: Forbid
    successfulJobsHistoryLimit: 3
    failedJobsHistoryLimit: 3
    jobTemplate:
        spec:
            template:
                metadata:
                    labels:
                        app: marketplace-price-tracker
                        component: postgres-backup
                spec:
                    restartPolicy: OnFailure
                    containers:
                        - name: pg-backup
                          image: postgres:18-alpine
                          imagePullPolicy: IfNotPresent
                          command:
                              - /bin/sh
                              - -c
                              - |
                                  set -euo pipefail
                                  TIMESTAMP="$(date +%Y%m%d%H%M%S)"
                                  BACKUP_FILE="/backup/price_tracker_bot-${TIMESTAMP}.sql"
                                  HOST_BACKUP_FILE="/host-backup/price_tracker_bot-${TIMESTAMP}.sql"
                                  echo "Starting backup to ${BACKUP_FILE}"
                                  PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
                                    -h postgres \
                                    -U "${POSTGRES_USER}" \
                                    -d "${POSTGRES_DB}" \
                                    --clean --if-exists \
                                    > "${BACKUP_FILE}"
                                  cp "${BACKUP_FILE}" "${HOST_BACKUP_FILE}"
                                  find /backup -type f -name 'price_tracker_bot-*.sql' -mtime +14 -delete
                                  find /host-backup -type f -name 'price_tracker_bot-*.sql' -mtime +30 -delete
                                  ls -lh /backup
                                  ls -lh /host-backup
                          env:
                              - name: POSTGRES_DB
                                valueFrom:
                                    configMapKeyRef:
                                        name: bot-config
                                        key: POSTGRES_DB
                              - name: POSTGRES_USER
                                valueFrom:
                                    configMapKeyRef:
                                        name: bot-config
                                        key: POSTGRES_USER
                              - name: POSTGRES_PASSWORD
                                valueFrom:
                                    secretKeyRef:
                                        name: bot-secrets
                                        key: POSTGRES_PASSWORD
                          securityContext:
                              runAsUser: 0
                              runAsGroup: 0
                              allowPrivilegeEscalation: true

                          volumeMounts:
                              - name: backup-storage
                                mountPath: /backup
                              - name: host-backup
                                mountPath: /host-backup

                    volumes:
                        - name: backup-storage
                          persistentVolumeClaim:
                              claimName: postgres-backup-pvc
                        - name: host-backup
                          hostPath:
                              path: /srv/backups/price-tracker
                              type: DirectoryOrCreate
